@inherits ComponentBase

<MudPaper Class="pa-3" Elevation="1">
    <MudText Typo="Typo.h6">Settings</MudText>
    <MudText Typo="Typo.caption" Class="mb-2">Edit Time to Live and message expiry options for the selected entity.</MudText>

    @if (!IsSelectionValid)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">Select a queue, topic, or subscription from the tree to edit settings.</MudAlert>
    }
    else
    {
        @if (SettingsLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        <MudGrid Class="mt-2">
            <MudItem xs="12" md="6">
                <MudTextField T="string" Label="Entity" Value="@SelectedFriendly" ReadOnly="true" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField T="string" @bind-Value="TtlText" Label="Default Message TTL (d.hh:mm:ss)" Placeholder="1.00:00:00" Immediate="true" />
                <MudText Typo="Typo.caption">Use d.hh:mm:ss (supports days), e.g., 1.00:00:00 for 1 day. Full TimeSpan format also accepted.</MudText>
            </MudItem>
            @if (ShowDeadLetterOnExpiration)
            {
                <MudItem xs="12" md="6">
                    <MudSwitch T="bool" @bind-Value="DeadLetterOnExpiration">Dead-letter on message expiration</MudSwitch>
                </MudItem>
            }
        </MudGrid>

        @if (ShowAdvancedSettings)
        {
            <MudExpansionPanels Elevation="0" Class="mt-2">
                <MudExpansionPanel Text="Advanced Settings">
                    <MudGrid Class="mt-1">
                        @if (SelectedIsQueue)
                        {
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" @bind-Value="LockDurationText" Label="Lock Duration (d.hh:mm:ss)" Placeholder="00:01:00" Immediate="true" />
                                <MudText Typo="Typo.caption">Use d.hh:mm:ss (e.g., 00:01:00 for 1 minute).</MudText>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField T="int" @bind-Value="MaxDeliveryCount" Label="Max Delivery Count" Min="1" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudSwitch T="bool" @bind-Value="EnableBatchedOperations">Enable Batched Operations</MudSwitch>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" @bind-Value="ForwardTo" Label="Forward To" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" @bind-Value="ForwardDeadLetteredTo" Label="Forward Dead-lettered To" Immediate="true" />
                            </MudItem>
                        }
                        else if (SelectedIsTopic)
                        {
                            <MudItem xs="12" md="6">
                                <MudSwitch T="bool" @bind-Value="EnableBatchedOperations">Enable Batched Operations</MudSwitch>
                            </MudItem>
                        }
                        else if (SelectedIsSubscription)
                        {
                            <MudItem xs="12" md="6">
                                <MudSwitch T="bool" @bind-Value="RequiresSession">Requires Session</MudSwitch>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" @bind-Value="LockDurationText" Label="Lock Duration (d.hh:mm:ss)" Placeholder="00:01:00" Immediate="true" />
                                <MudText Typo="Typo.caption">Use d.hh:mm:ss (e.g., 00:01:00 for 1 minute).</MudText>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField T="int" @bind-Value="MaxDeliveryCount" Label="Max Delivery Count" Min="1" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudSwitch T="bool" @bind-Value="EnableBatchedOperations">Enable Batched Operations</MudSwitch>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" @bind-Value="ForwardTo" Label="Forward To" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" @bind-Value="ForwardDeadLetteredTo" Label="Forward Dead-lettered To" Immediate="true" />
                            </MudItem>
                        }
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

        <div class="mt-3">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!CanSave)" OnClick="@OnSave">Save</MudButton>
            <MudButton Class="ml-2" Variant="Variant.Outlined" Disabled="@(SettingsLoading || SettingsSaving)" OnClick="@OnReset">Reset</MudButton>
        </div>
    }
</MudPaper>

@code {
    [Parameter] public bool IsSelectionValid { get; set; }
    [Parameter] public string SelectedFriendly { get; set; } = string.Empty;

    [Parameter] public string TtlText { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> TtlTextChanged { get; set; }

    [Parameter] public bool DeadLetterOnExpiration { get; set; }
    [Parameter] public EventCallback<bool> DeadLetterOnExpirationChanged { get; set; }

    [Parameter] public bool ShowDeadLetterOnExpiration { get; set; }

    [Parameter] public bool SelectedIsQueue { get; set; }
    [Parameter] public bool SelectedIsTopic { get; set; }
    [Parameter] public bool SelectedIsSubscription { get; set; }

    [Parameter] public string LockDurationText { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> LockDurationTextChanged { get; set; }

    [Parameter] public int MaxDeliveryCount { get; set; }
    [Parameter] public EventCallback<int> MaxDeliveryCountChanged { get; set; }

    [Parameter] public bool EnableBatchedOperations { get; set; }
    [Parameter] public EventCallback<bool> EnableBatchedOperationsChanged { get; set; }

    [Parameter] public string? ForwardTo { get; set; }
    [Parameter] public EventCallback<string?> ForwardToChanged { get; set; }

    [Parameter] public string? ForwardDeadLetteredTo { get; set; }
    [Parameter] public EventCallback<string?> ForwardDeadLetteredToChanged { get; set; }

    [Parameter] public bool RequiresSession { get; set; }
    [Parameter] public EventCallback<bool> RequiresSessionChanged { get; set; }

    [Parameter] public bool SettingsLoading { get; set; }
    [Parameter] public bool SettingsSaving { get; set; }
    [Parameter] public bool CanSave { get; set; }

    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnReset { get; set; }

    private bool ShowAdvancedSettings => SelectedIsQueue || SelectedIsTopic || SelectedIsSubscription;
}
