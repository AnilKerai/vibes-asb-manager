@using Vibes.ASBManager.Web.Models
<MudDialog>
    <TitleContent>@Title</TitleContent>
    <DialogContent>
        <MudForm @ref="_form">
            <MudTextField @ref="_connField" Label="Connection String"
                          Placeholder="Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
                          HelperText="Stored securely; hidden by default"
                          @bind-Value="_connString" @bind-Value:after="OnConnStringAfter" Required="true"
                          InputType="@(_showConn ? InputType.Text : InputType.Password)"
                          Adornment="Adornment.End"
                          AdornmentIcon="@(_showConn ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                          OnAdornmentClick="@ToggleShowConn"
                          tabindex="1" />
            <MudTextField Label="Name" Placeholder="e.g. mynamespace" HelperText="Defaults to namespace from connection string" @bind-Value="_name" @bind-Value:after="OnNameAfter" tabindex="2" />
        </MudForm>
        @if (OperatingSystem.IsMacCatalyst())
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                Tip: On macOS, Tab navigation may be disabled by system settings. Enable "Keyboard navigation" in System Settings â†’ Keyboard to move focus between controls.
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <DialogActionButtons SaveText="Save" CancelTabIndex="4" SaveTabIndex="5" OnCancel="OnCancel" OnSave="OnSave" />
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }
    [Parameter] public string Title { get; set; } = "Add Connection";

    private MudForm? _form;
    private MudTextField<string>? _connField;
    private string _connString = string.Empty;
    private string _name = string.Empty;
    private bool _nameTouched;
    private bool _showConn;

    private async Task OnSave()
    {
        if (_form is not null)
        {
            await _form.Validate();
            if (!_form.IsValid)
                return;
        }
        var req = new AddConnectionRequest
        {
            Name = GetFinalName(),
            ConnectionString = _connString.Trim(),
        };
        MudDialog?.Close(DialogResult.Ok(req));
    }

    private void OnCancel() => MudDialog?.Cancel();

    private Task OnConnStringAfter()
    {
        if (!_nameTouched || string.IsNullOrWhiteSpace(_name))
        {
            var derived = ConnectionStringParser.GetName(_connString);
            if (!string.IsNullOrWhiteSpace(derived))
                _name = derived!;
        }
        return Task.CompletedTask;
    }

    private Task OnNameAfter()
    {
        _nameTouched = true;
        return Task.CompletedTask;
    }

    

    private string GetFinalName()
    {
        if (!string.IsNullOrWhiteSpace(_name))
            return _name.Trim();
        var derived = ConnectionStringParser.GetName(_connString);
        return string.IsNullOrWhiteSpace(derived) ? string.Empty : derived!;
    }

    private void ToggleShowConn() => _showConn = !_showConn;
}
